<?php namespace ProcessWire; 
 
/**
 * Admin Theme Tweaker
 * @author Chris Bennett
 * ProcessWire 3.x
 * Copyright (C) 2011 by Ryan Cramer
 * Licensed under GNU/GPL v2, see LICENSE.TXT
 * http://www.processwire.com
 * http://www.ryancramer.com
 */

class AdminThemeTweaker extends WireData implements Module {
	
    const MODULE_NAME       = 'AdminThemeTweaker';
	const MODULE_DIR        = '../../' . self::MODULE_NAME;
    const VERSION           = '1.0.5';
    const SUMMARY           = 'Easily tweak default Uikit Theme';
    const AUTHOR            = 'bene - Chris Bennett';
    const ICON              = 'wrench';

	public static function getModuleInfo() {
		return array(
			'title'       => self::MODULE_NAME,
			'summary'     => self::SUMMARY,
			'version'     => self::VERSION,			
            'author'      => self::AUTHOR,
			'autoload'    => 'template=admin',
			'icon'        => self::ICON,
			'requires'    => 'ProcessWire>=3.0.16, AdminThemeUikit',
		);
	}

	public function init() {
		$this->config->styles->add( $this->config->urls->siteModules.'AdminThemeTweaker/AdminThemeTweaker.css' );
	}

    public function ready() {
		
		$cssPath    = $this->config->paths->siteModules.'AdminThemeTweaker/AdminThemeTweaker.css';

		$moduleName = $this->input->name;
		if( $moduleName == 'AdminThemeTweaker') { // Load module specific hooks, styles, scripts 
			if ($this->showThemeTweaker) {
				function minifyCSS($css) {
					return str_replace('; ',';',str_replace(' }','}',
					str_replace('{ ','{',str_replace(array("\r\n","\r","\n","\t",'  ','    ','    '),"",
					preg_replace('!/\*[^*]*\*+([^/][^*]*\*+)*/!','',$css)))));																																							
			    }

		        $this->config->scripts->add($this->config->urls->siteModules.'AdminThemeTweaker/AdminThemeTweaker.js');
		    
				include( 'Engine/CSSvariables.php' );

				$cssOutput  = $cssVariables;
				$cssOutput .= $conditionalVariables;
				$cssOutput .= '}'; //closes :root
				$cssOutput .= file_get_contents ( $this->config->paths->siteModules.'AdminThemeTweaker/Engine/AdminThemeTweakerFramework.css' );
				$cssOutput .= file_get_contents ( $this->config->paths->siteModules.'AdminThemeTweaker/Engine/AdminThemeTweakerStyleTree.css' );
				if( $this->spacesave_heading ) {
					$cssOutput .= file_get_contents ( $this->config->paths->siteModules.'AdminThemeTweaker/Engine/AdminThemeTweakerSpaceSaver.css' );	
				}
				if( $this->toggleCheckbox ) {
					$cssOutput .= file_get_contents ( $this->config->paths->siteModules.'AdminThemeTweaker/Engine/AdminThemeTweakerToggleCheckbox.css' );	
				}
	            if( !$this->show_shadows ) {
				    $cssOutput .= '#pw-content-body * {box-shadow: none!important;}';
				}
				if( $this->styleScrollbar ) {
					$cssOutput .= file_get_contents ( $this->config->paths->siteModules.'AdminThemeTweaker/Engine/AdminThemeTweakerStyleScrollbar.css' );
				}
				
                $cssOutput .= $svgIncVariables;				
				
				file_put_contents ( $cssPath, minifyCSS($cssOutput) );
				
			}
		}
		
		if ($this->showThemeTweaker) {
			
			$this->config->styles->add( $this->config->urls->siteModules . 'AdminThemeTweaker/AdminThemeTweaker.css?v='.filemtime($cssPath) );
			
		} else {
			
			$this->config->styles->remove( $this->config->urls->siteModules . 'AdminThemeTweaker/AdminThemeTweaker.css' );
		}
		
	}
	
	public function uninstall() {
		
		// Clean up after ourselves on uninstall. If MODULE_DIR exists, find and delete contents then remove folder.
		
		function rrmdir($dir) {
			if (is_dir($dir)) {
				$objects = scandir($dir);
				foreach ($objects as $object) {
					if ($object != "." && $object != "..") {
						if (filetype($dir."/".$object) == "dir") 
							 rrmdir($dir."/".$object); 
						else unlink   ($dir."/".$object);
					}
				}
				reset($objects);
				rmdir($dir);
				}
		 }
		rrmdir(self::MODULE_DIR);
  }	

  
  
  
}